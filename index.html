/*************************************************
 * TimeArena Gamify â€” FULL GAME ENGINE
 * Kid: Nikita (11 ani)
 *************************************************/

const state = {
  userName: "Nikita",

  level: 1,
  points: 0,
  nextLevelAt: 100,

  completedToday: [],

  responsibilities: [
    { id:"r-homework", title:"Eroul Temelor", desc:"1h teme + pregÄƒtire", category:"È˜coalÄƒ", points:25 },
    { id:"r-languages", title:"Maestrul Limbilor", desc:"1h limbi strÄƒine", category:"È˜coalÄƒ", points:25 },
    { id:"r-school", title:"PregÄƒtit de È˜coalÄƒ", desc:"La timp + ghiozdan", category:"Responsabilitate", points:15 }
  ],

  winners: [
    { id:"w-bed", title:"Gardianul Patului", desc:"ÃÈ›i faci patul", category:"Responsabilitate", points:10 },
    { id:"w-room", title:"StÄƒpÃ¢nul Camerei", desc:"CurÄƒÈ›enie completÄƒ", category:"Responsabilitate", points:20 },
    { id:"w-dishes", title:"Eroul Veselei", desc:"Speli vasele", category:"Responsabilitate", points:15 },
    { id:"w-listen", title:"AscultÄƒtorul Ninja", desc:"EÈ™ti atent", category:"Comportament", points:10 },
    { id:"w-truth", title:"Cavalerul AdevÄƒrului", desc:"Spui adevÄƒrul", category:"Comportament", points:15 },
    { id:"w-read", title:"Cititorul Curajos", desc:"20 min citit", category:"È˜coalÄƒ", points:10 },
    { id:"w-sport", title:"Legenda Sportului", desc:"Participi activ", category:"Sport", points:30 },
    { id:"w-family", title:"Eroul Familiei", desc:"Timp cu familia", category:"Familie", points:10 }
  ],

  losers: [
    { id:"l-drama", title:"Drama Mode", desc:"Victimizare", category:"Comportament", points:-15 },
    { id:"l-pain", title:"MÄƒ Doareâ„¢", desc:"ScuzÄƒ falsÄƒ", category:"Comportament", points:-20 },
    { id:"l-lie", title:"Umbra Minciunii", desc:"MinciunÄƒ", category:"Comportament", points:-25 },
    { id:"l-avoid", title:"Evitare", desc:"Evitare task", category:"Responsabilitate", points:-20 }
  ],

  store: [
    { id:"s-yt20", title:"+20 min YouTube", cost:40 },
    { id:"s-ps20", title:"+20 min PlayStation", cost:50 },
    { id:"s-movie", title:"Aleg Filmul", cost:30 }
  ]
};

/* ================= UTIL ================= */
const $ = s => document.querySelector(s);

/* ================= GAME LOGIC ================= */
function gainPoints(delta){
  state.points = Math.max(0, state.points + delta);
  while (state.points >= state.nextLevelAt){
    state.points -= state.nextLevelAt;
    state.level++;
    state.nextLevelAt = Math.round(state.nextLevelAt * 1.15);
  }
}

function areResponsibilitiesDone(){
  const done = state.completedToday.map(x => x.id);
  return state.responsibilities.every(r => done.includes(r.id));
}

/* ================= UI HELPERS ================= */
function updateHeader(){
  $("#welcomeTitle").textContent = `Salut, ${state.userName}! ğŸ‘‹`;
  $("#level").textContent = state.level;
  $("#points").textContent = state.points;
  $("#miniLevel").textContent = state.level;
  $("#miniPoints").textContent = state.points;

  $("#toNext").textContent = Math.max(0, state.nextLevelAt - state.points);
  $("#progressBar").style.width =
    Math.min(100, (state.points / state.nextLevelAt) * 100) + "%";
}

function questCard(x, mode){
  const done = mode === "done";
  const isLoser = x.points < 0;

  return `
    <div class="quest">
      <div class="left">
        <div class="ic">${isLoser ? "âš ï¸" : "ğŸ¯"}</div>
        <div>
          <div class="q-title">${x.title}</div>
          <div class="q-desc">${x.desc}</div>
          <div class="meta">
            <span class="pill pill-cat">${x.category}</span>
            <span class="pill pill-xp">${x.points > 0 ? "+" : ""}${x.points} XP</span>
          </div>
        </div>
      </div>
      <div class="action">
        ${
          done
            ? `<span class="btn-done">âœ” Finalizat</span>`
            : `<button class="btn-go" onclick="completeQuest('${x.id}')">
                 ${isLoser ? "AplicÄƒ" : "FinalizeazÄƒ"}
               </button>`
        }
      </div>
    </div>
  `;
}

function storeCard(x){
  return `
    <div class="store-item">
      <div class="store-top">
        <div>
          <div class="store-title">${x.title}</div>
        </div>
        <span class="pill pill-xp">${x.cost} XP</span>
      </div>
      <button class="btn-buy" onclick="buyReward('${x.id}')">CumpÄƒrÄƒ</button>
    </div>
  `;
}

/* ================= ACTIONS ================= */
function completeQuest(id){
  const all = [...state.responsibilities, ...state.winners, ...state.losers];
  const q = all.find(x => x.id === id);
  if (!q) return;

  gainPoints(q.points);
  state.completedToday.push(q);
  render();
}

function buyReward(id){
  const r = state.store.find(x => x.id === id);
  if (!r) return;

  if (state.points < r.cost){
    alert("Nu ai suficient XP.");
    return;
  }
  state.points -= r.cost;
  alert(`RecompensÄƒ cÃ¢È™tigatÄƒ: ${r.title}`);
  render();
}

/* ================= RENDER ================= */
function render(){
  updateHeader();

  $("#responsibilitiesList").innerHTML =
    state.responsibilities.map(x => questCard(x)).join("");
  $("#responsibilitiesFull").innerHTML =
    state.responsibilities.map(x => questCard(x)).join("");

  $("#winnersList").innerHTML =
    state.winners.slice(0,6).map(x => questCard(x)).join("");
  $("#winnersGrid").innerHTML =
    state.winners.map(x => questCard(x)).join("");
  $("#losersGrid").innerHTML =
    state.losers.map(x => questCard(x)).join("");

  $("#doneQuests").innerHTML =
    state.completedToday.length
      ? state.completedToday.map(x => questCard(x,"done")).join("")
      : `<div class="muted small">Nicio misiune azi.</div>`;

  $("#storeList").innerHTML =
    state.store.map(x => storeCard(x)).join("");

  const unlocked = areResponsibilitiesDone();
  $("#bonusState").textContent = unlocked ? "ğŸ”“ Deblocat" : "ğŸ”’ BlocAT";
  $("#lockBadge").textContent = unlocked ? "BONUS DEBLOCAT" : "BONUS BLOCAT";
}

render();
